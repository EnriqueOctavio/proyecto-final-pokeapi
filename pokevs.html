<div class="vs-container">
  
  <!-- Buscadores -->
  <div class="vs-buscadores">
    <div class="vs-buscador">
      <input type="text" class="campo-texto vs-input" id="pokemon1-input" placeholder="POK√âMON 1...">
      <button class="botones boton-buscar vs-btn-buscar" id="btn-buscar-p1">BUSCAR</button>
    </div>

    <span class="vs-texto">VS</span>

    <div class="vs-buscador">
      <input type="text" class="campo-texto vs-input" id="pokemon2-input" placeholder="POK√âMON 2...">
      <button class="botones boton-buscar vs-btn-buscar" id="btn-buscar-p2">BUSCAR</button>
    </div>
  </div>


  <!-- Boton batallar -->
  <div class="vs-batallar-container">
    <button class="botones vs-btn-batallar" id="btn-batallar" disabled>
      ‚öîÔ∏è ¬°BATALLAR!
    </button>
  </div>


  <!-- Cards de pokemon -->
  <div class="vs-cards-container">
    <div class="vs-card" id="vs-card-p1">
      <div class="vs-card-origen-container">
        <span class="vs-card-origen" id="origen-p1"></span>
      </div>
      <div class="vs-card-vacia">
        <span>?</span>
      </div>
    </div>

    <div class="vs-espadas">‚öîÔ∏è</div>

    <div class="vs-card" id="vs-card-p2">
      <span class="vs-card-origen" id="origen-p2"></span>
      <div class="vs-card-vacia">
        <span>?</span>
      </div>
    </div>
  </div>


  <!-- Resultado de la batalla -->
  <div class="vs-resultado" id="vs-resultado">
    <div class="vs-resultado-vacio">
      <span>‚öîÔ∏è</span>
    </div>
  </div>

</div>


<script>
(function() {

  // Variables para guardar los pokemon seleccionados
  var pokemon1 = null;
  var pokemon2 = null;

  // Cache de tipos para no hacer m√∫ltiples llamadas
  var tiposCache = {};

  var elems = {
    inputP1: document.getElementById('pokemon1-input'),
    inputP2: document.getElementById('pokemon2-input'),
    btnBuscarP1: document.getElementById('btn-buscar-p1'),
    btnBuscarP2: document.getElementById('btn-buscar-p2'),
    btnBatallar: document.getElementById('btn-batallar'),
    cardP1: document.getElementById('vs-card-p1'),
    cardP2: document.getElementById('vs-card-p2'),
    origenP1: document.getElementById('origen-p1'),
    origenP2: document.getElementById('origen-p2'),
    resultado: document.getElementById('vs-resultado')
  };


  // Template para mostrar pokemon en la card
  function pokemon_card(pokemon) {
    var esFavorito = verificarSiEsFavorito(pokemon.id);
    return '<div class="vs-pokemon-info">' +
      '<img src="' + pokemon.sprites.front_default + '" alt="' + pokemon.name + '" class="vs-pokemon-img">' +
      '<div class="vs-pokemon-datos">' +
        '<span class="vs-pokemon-nombre">' + pokemon.name.toUpperCase() + '</span>' +
      '</div>' +
      '<div class="vs-pokemon-tipos">' +
        pokemon.types.map(function(t) { 
          return '<span class="vs-tipo-tag">' + t.type.name.toUpperCase() + '</span>'; 
        }).join('') +
      '</div>' +
      '<div class="vs-favorito-container">' +
        '<button class="botones vs-btn-favorito ' + (esFavorito ? 'es-favorito' : '') + '" data-pokemon-id="' + pokemon.id + '">' +
          (esFavorito ? '‚ù§Ô∏è' : 'ü§ç') +
        '</button>' +
      '</div>' +
    '</div>';
  }


  // Template para la card en el resultado de batalla
  function batalla_card(pokemon, puntaje, esGanador, esFavorito) {
    var claseCard = esGanador ? 'batalla-card batalla-card--ganador' : 'batalla-card batalla-card--perdedor';
    
    return '<div class="' + claseCard + '">' +
      (esGanador ? '<div class="batalla-ganador-badge">üèÜ GANADOR</div>' : '') +
      '<img src="' + pokemon.sprites.front_default + '" alt="' + pokemon.name + '" class="batalla-pokemon-img">' +
      '<h3 class="batalla-pokemon-nombre">' + pokemon.name.toUpperCase() + '</h3>' +
      '<div class="batalla-pokemon-tipos">' +
        pokemon.types.map(function(t) { 
          return '<span class="batalla-tipo-tag">' + t.type.name.toUpperCase() + '</span>'; 
        }).join('') +
      '</div>' +
      '<div class="batalla-puntaje">' + puntaje.toFixed(1) + ' pts</div>' +
      '<div class="batalla-favorito-container">' +
        '<button class="botones batalla-btn-favorito ' + (esFavorito ? 'es-favorito' : '') + '" data-pokemon-id="' + pokemon.id + '">' +
          (esFavorito ? '‚ù§Ô∏è' : 'ü§ç') +
        '</button>' +
      '</div>' +
    '</div>';
  }


  // Verificar si un pokemon esta en favoritos
  function verificarSiEsFavorito(id) {
    var favs = JSON.parse(localStorage.getItem('favoritos_pokemon')) || [];
    return favs.some(function(p) { return p.id === id; });
  }


  // Agregar o quitar de favoritos desde VS
  function toggleFavoritoVS(pokemon) {
    var favs = JSON.parse(localStorage.getItem('favoritos_pokemon')) || [];
    var existe = favs.some(function(p) { return p.id === pokemon.id; });

    if (existe) {
      favs = favs.filter(function(p) { return p.id !== pokemon.id; });
    } else {
      favs.push({
        id: pokemon.id,
        nombre: pokemon.name.toUpperCase(),
        imagen: pokemon.sprites.front_default,
        tipos: pokemon.types.map(function(t) { return t.type.name.toUpperCase(); })
      });
    }

    localStorage.setItem('favoritos_pokemon', JSON.stringify(favs));
  }


  // Obtener datos de un tipo de la API
  async function obtenerDatosTipo(nombreTipo) {

    var tipoDelPoke = 'tipo_' + nombreTipo;

    var res = await fetch('https://pokeapi.co/api/v2/type/' + nombreTipo);
    var data = await res.json();
    
    return data;
  }


  // Calcular multiplicador de tipo (atacante vs defensor)
  async function calcularMultiplicadorTipo(tiposAtacante, tiposDefensor) {
    var multiplicador = 1.0;
    
    for (var i = 0; i < tiposAtacante.length; i++) {
      var tipoAtacante = tiposAtacante[i].type.name;
      var datosTipo = await obtenerDatosTipo(tipoAtacante);
      
      console.log(datosTipo);
      
      var dobleDano = datosTipo.damage_relations.double_damage_to;
      for (var j = 0; j < dobleDano.length; j++) {
        for (var k = 0; k < tiposDefensor.length; k++) {
          if (dobleDano[j].name === tiposDefensor[k].type.name) {
            multiplicador *= 2.0;
          }
        }
      }
      
      
      var medioDano = datosTipo.damage_relations.half_damage_to;
      for (var j = 0; j < medioDano.length; j++) {
        for (var k = 0; k < tiposDefensor.length; k++) {
          if (medioDano[j].name === tiposDefensor[k].type.name) {
            multiplicador *= 0.5;
          }
        }
      }
      
      
      var sinDano = datosTipo.damage_relations.no_damage_to;
      for (var j = 0; j < sinDano.length; j++) {
        for (var k = 0; k < tiposDefensor.length; k++) {
          if (sinDano[j].name === tiposDefensor[k].type.name) {
            multiplicador *= 0;
          }
        }
      }
    }

    console.log('multiplicador', multiplicador);
    return multiplicador;
    
  }



  function calcularStatsTotal(pokemon) {
    var total = 0;
    for (var i = 0; i < pokemon.stats.length; i++) {

      total += pokemon.stats[i].base_stat;
    }


    console.log('total de base', total);
    return total;
  }


  
  function obtenerDescripcionEfectividad(multiplicador, tipoAtacante, tipoDefensor) {
    if (multiplicador >= 2.0) {
      return tipoAtacante + ' es s√∫per efectivo contra ' + tipoDefensor;
    } else if (multiplicador <= 0.5 && multiplicador > 0) {
      return tipoAtacante + ' es poco efectivo contra ' + tipoDefensor;
    } else if (multiplicador === 0) {
      return tipoAtacante + ' no afecta a ' + tipoDefensor;
    } else {
      return tipoAtacante + ' es neutral contra ' + tipoDefensor;
    }
  }


  // Nombres de stats
  var nombresStats = {
    'hp': 'HP',
    'attack': 'ATK',
    'defense': 'DEF',
    'special-attack': 'SP.ATK',
    'special-defense': 'SP.DEF',
    'speed': 'SPD'
  };


  
  function generarComparacionStats(p1, p2) {
    var html = '';
    var maxStat = 200; // Valor m√°ximo para las barras
    
    for (var i = 0; i < p1.stats.length; i++) {
      var stat1 = p1.stats[i].base_stat;
      var stat2 = p2.stats[i].base_stat;
      var nombreStat = nombresStats[p1.stats[i].stat.name] || p1.stats[i].stat.name;
      
      var porcentaje1 = (stat1 / maxStat) * 100;
      var porcentaje2 = (stat2 / maxStat) * 100;
      
      var color1 = stat1 > stat2 ? '#4ecdc4' : (stat1 < stat2 ? '#ff6b6b' : '#ffcc00');
      var color2 = stat2 > stat1 ? '#4ecdc4' : (stat2 < stat1 ? '#ff6b6b' : '#ffcc00');
      
      html += '<div class="stats-comparacion-fila">' +
        '<span class="stats-valor stats-valor-izq ' + (stat1 > stat2 ? 'stats-ganador' : '') + '">' + stat1 + '</span>' +
        '<div class="stats-barra-izq">' +
          '<div class="stats-barra-relleno" style="width:' + porcentaje1 + '%; background-color:' + color1 + '"></div>' +
        '</div>' +
        '<span class="stats-nombre-centro">' + nombreStat + '</span>' +
        '<div class="stats-barra-der">' +
          '<div class="stats-barra-relleno" style="width:' + porcentaje2 + '%; background-color:' + color2 + '"></div>' +
        '</div>' +
        '<span class="stats-valor stats-valor-der ' + (stat2 > stat1 ? 'stats-ganador' : '') + '">' + stat2 + '</span>' +
      '</div>';
    }
    
    return html;
  }


  // Buscar pokemon 
  async function buscar_pokemon_vs(nombre, numero) {
    var card = numero === 1 ? elems.cardP1 : elems.cardP2;
    var origen = numero === 1 ? elems.origenP1 : elems.origenP2;

    card.innerHTML = '<div class="estado-cargando"><p>Cargando...</p></div>';

    try {
      var resultado = await traerPoke(nombre.toLowerCase().trim());
      
      if (numero === 1) {
        pokemon1 = resultado.data;
      } else {
        pokemon2 = resultado.data;
      }

      origen.textContent = resultado.origen === 'cache' ? 'üì¶ CACH√â' : 'üåê API';
      origen.className = 'vs-card-origen ' + (resultado.origen === 'cache' ? 'origen-cache' : 'origen-api');
      
      var origenTag = '<span class="vs-card-origen ' + (resultado.origen === 'cache' ? 'origen-cache' : 'origen-api') + '">' + 
        (resultado.origen === 'cache' ? 'üì¶ CACH√â' : 'üåê API') + '</span>';
      card.innerHTML = origenTag + pokemon_card(resultado.data);

      // Agregar evento al boton de favoritos
      var btnFav = card.querySelector('.vs-btn-favorito');
      if (btnFav) {
        btnFav.addEventListener('click', function() {
          toggleFavoritoVS(resultado.data);
          var esFav = verificarSiEsFavorito(resultado.data.id);
          btnFav.textContent = esFav ? '‚ù§Ô∏è' : 'ü§ç';
          if (esFav) {
            btnFav.classList.add('es-favorito');
          } else {
            btnFav.classList.remove('es-favorito');
          }
        });
      }

      verificar_batallar();

    } catch (error) {
      card.innerHTML = '<div class="estado-error"><h3>No encontrado</h3></div>';
      
      if (numero === 1) {
        pokemon1 = null;
      } else {
        pokemon2 = null;
      }
      
      verificar_batallar();
    }
  }


  // Validaci√≥n extra para que valide si se puede batallar (si los imputs estan vacios)
  function verificar_batallar() {
    elems.btnBatallar.disabled = !(pokemon1 && pokemon2);
  }


  // FUNCI√ìN PRINCIPAL DE BATALLA
  async function ejecutarBatalla() {
    if (!pokemon1 || !pokemon2) return;

    // Mostrar cargando
    elems.resultado.innerHTML = '<div class="estado-cargando"><p>Calculando batalla...</p></div>';

    try {
      
      var mult1vs2 = await calcularMultiplicadorTipo(pokemon1.types, pokemon2.types);
      var mult2vs1 = await calcularMultiplicadorTipo(pokemon2.types, pokemon1.types);

      
      var statsTotal1 = calcularStatsTotal(pokemon1);
      var statsTotal2 = calcularStatsTotal(pokemon2);

      
      var puntaje1 = statsTotal1 * mult1vs2;
      var puntaje2 = statsTotal2 * mult2vs1;

      // Determinar ganador
      var ganador = puntaje1 > puntaje2 ? 1 : (puntaje2 > puntaje1 ? 2 : 0);

      // Obtener tipos como texto
      var tipo1 = pokemon1.types.map(function(t) { return t.type.name; }).join('/');
      var tipo2 = pokemon2.types.map(function(t) { return t.type.name; }).join('/');

      
      var desc1vs2 = obtenerDescripcionEfectividad(mult1vs2, tipo1, tipo2);
      var desc2vs1 = obtenerDescripcionEfectividad(mult2vs1, tipo2, tipo1);

      
      var esFav1 = verificarSiEsFavorito(pokemon1.id);
      var esFav2 = verificarSiEsFavorito(pokemon2.id);

      
      var resultadoHTML = 
        '<div class="batalla-resultado">' +
          
          // T√≠tulo
          '<h2 class="batalla-titulo">‚öîÔ∏è RESULTADO DE LA BATALLA ‚öîÔ∏è</h2>' +
          '<div class="batalla-linea-divisora"></div>' +
          
          // Cards de los pokemon
          '<div class="batalla-cards">' +
            batalla_card(pokemon1, puntaje1, ganador === 1, esFav1) +
            '<span class="batalla-vs-texto">VS</span>' +
            batalla_card(pokemon2, puntaje2, ganador === 2, esFav2) +
          '</div>' +

          // An√°lisis de batalla
          '<h3 class="analisis-titulo">üìä AN√ÅLISIS DE BATALLA</h3>' +
          
          // Ventajas de tipo
          '<div class="analisis-seccion">' +
            '<h4 class="analisis-subtitulo">‚ö° VENTAJAS DE TIPO</h4>' +
            '<div class="ventajas-container">' +
              '<div class="ventaja-item ' + (mult1vs2 < 1 ? 'ventaja-desfavorable' : (mult1vs2 > 1 ? 'ventaja-favorable' : '')) + '">' +
                '<span class="ventaja-nombre"><strong>' + pokemon1.name + '</strong> vs ' + pokemon2.name + ': <strong>x' + mult1vs2.toFixed(2) + '</strong></span>' +
                '<span class="ventaja-desc">' + desc1vs2 + '</span>' +
              '</div>' +
              '<div class="ventaja-item ' + (mult2vs1 < 1 ? 'ventaja-desfavorable' : (mult2vs1 > 1 ? 'ventaja-favorable' : '')) + '">' +
                '<span class="ventaja-nombre"><strong>' + pokemon2.name + '</strong> vs ' + pokemon1.name + ': <strong>x' + mult2vs1.toFixed(2) + '</strong></span>' +
                '<span class="ventaja-desc">' + desc2vs1 + '</span>' +
              '</div>' +
            '</div>' +
          '</div>' +

          // Comparaci√≥n de stats
          '<div class="analisis-seccion">' +
            '<h4 class="analisis-subtitulo">üìà COMPARACI√ìN DE STATS</h4>' +
            '<div class="stats-comparacion">' +
              generarComparacionStats(pokemon1, pokemon2) +
            '</div>' +
          '</div>' +

          // C√°lculo del puntaje
          '<div class="analisis-seccion">' +
            '<h4 class="analisis-subtitulo">üßÆ C√ÅLCULO DEL PUNTAJE</h4>' +
            '<div class="calculo-container">' +
              '<p><strong>Stats Base Total:</strong> ' + pokemon1.name + ': ' + statsTotal1 + ' | ' + pokemon2.name + ': ' + statsTotal2 + '</p>' +
              '<p><strong>Multiplicador de Tipo:</strong> ' + pokemon1.name + ': x' + mult1vs2.toFixed(2) + ' | ' + pokemon2.name + ': x' + mult2vs1.toFixed(2) + '</p>' +
              '<p><strong>Puntaje Final:</strong> ' + pokemon1.name + ': ' + puntaje1.toFixed(1) + ' | ' + pokemon2.name + ': ' + puntaje2.toFixed(1) + '</p>' +
            '</div>' +
          '</div>' +

        '</div>';



      elems.resultado.innerHTML = resultadoHTML;

    
      var btnsResultado = elems.resultado.querySelectorAll('.batalla-btn-favorito');
      btnsResultado.forEach(function(btn, index) {
        var poke = index === 0 ? pokemon1 : pokemon2;
        btn.addEventListener('click', function() {
          toggleFavoritoVS(poke);
          var esFav = verificarSiEsFavorito(poke.id);
          btn.textContent = esFav ? '‚ù§Ô∏è' : 'ü§ç';
          if (esFav) {
            btn.classList.add('es-favorito');
          } else {
            btn.classList.remove('es-favorito');
          }
        });
      });

    } catch (error) {
      console.error('Error en batalla:', error);
      elems.resultado.innerHTML = '<div class="estado-error"><h3>Error al calcular batalla</h3></div>';
    }
  }



  elems.btnBuscarP1.addEventListener('click', function() {
    var nombre = elems.inputP1.value;
    if (nombre) buscar_pokemon_vs(nombre, 1);
  });



  elems.btnBuscarP2.addEventListener('click', function() {
    var nombre = elems.inputP2.value;
    if (nombre) buscar_pokemon_vs(nombre, 2);
  });



  
  elems.btnBatallar.addEventListener('click', function() {
    ejecutarBatalla();
  });

})();
</script>
